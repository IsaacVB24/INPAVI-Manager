<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro beneficiarios</title>
  <link href="https://fonts.googleapis.com/css?family=Karla:400,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.8.95/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/style2.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="#">Integración Para La Vida</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="#">Inicio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Acerca de</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Servicios</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Contacto</a>
        </li>
      </ul>
    </div>
  </nav>
  <br>
  <div class="row main-content">
    <div class="container mt-5">
      <div class="form-border">
        <h2 class="mb-4">Registro beneficiarios. Datos del familiar</h2>
        <form id="alta_bene_fam" action="/AltaBeneFamiliar" method="post">
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="nombre_fam">Nombre del familiar</label>
              <input type="text" class="form-control" id="nombre_fam" name="nombre_fam" placeholder="Nombre familiar" required>
            </div>
            <div class="form-group col-md-4">
              <label for="apellido_paterno_fam">Apellido Paterno familiar</label>
              <input type="text" class="form-control" id="apellido_paterno_fam" name="apellido_paterno_fam" placeholder="Apellido Paterno familiar" required>
            </div>
            <div class="form-group col-md-4">
              <label for="apellido_materno_fam">Apellido Materno familiar</label>
              <input type="text" class="form-control" id="apellido_materno_fam" name="apellido_materno_fam" placeholder="Apellido Materno familiar" required> 
            </div>
          </div>
          <br><br>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="fecha_nacimiento_fam">Fecha de nacimiento del familiar</label>
              <input type="date" class="form-control" id="fecha_nacimiento_fam" name="fecha_nacimiento_fam" placeholder="Fecha de nacimiento del familiar" required>
            </div>
            <div class="form-group col-md-4">
              <label for="Edad_fam">Edad del familiar</label>
              <input type="text" class="form-control" id="Edad_fam" name="Edad_fam" placeholder="Edad del familiar" readonly>
            </div>    
            <div class="form-group col-md-4">
              <label for="situacion_laboral_fam">Situación laboral del familiar</label>
              <select class="form-control" id="situacion_laboral_fam" name="situacion_laboral_fam" required>
                <option value="">Selecciona una opción</option>
                <option value="Empleado">Empleado</option>
                <option value="Desempleado" selected>Desempleado</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label for="nivel_estudios_fam">Nivel de estudios del familiar</label>
              <select class="form-control" id="nivel_estudios_fam" name="nivel_estudios_fam" required>
                <option value="">Selecciona una opción</option>
                <option value="Básico">Básico 1</option>
                <option value="Medio Superior" selected>Medio Superior</option>
                <option value="Superior">Superior</option>
              </select>
            </div>         
          </div>
          <br><br>
          <button type="submit" class="btn btn-block login-btn mb-4">Siguiente</button>
        </form>
      </div>
    </div>
  </div>
  <script type="module">
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar opciones de Situación Laboral y Nivel de Estudios desde el servidor
      fetch('/opciones')
        .then(response => response.json())
        .then(data => {
          const situacionLaboralSelect = document.getElementById('situacion_laboral_fam');
          const nivelEstudiosSelect = document.getElementById('nivel_estudios_fam');

          // Llenar select de Situación Laboral
          data.situacionLaboral.forEach(opcion => {
            const option = document.createElement('option');
            option.value = opcion;
            option.textContent = opcion;
            situacionLaboralSelect.appendChild(option);
          });

          // Llenar select de Nivel de Estudios
          data.nivelEstudios.forEach(opcion => {
            const option = document.createElement('option');
            option.value = opcion;
            option.textContent = opcion;
            nivelEstudiosSelect.appendChild(option);
          });
        })
        .catch(error => console.error('Error al obtener opciones:', error));

      // Función para calcular la edad a partir de la fecha de nacimiento
      function calculateAge(birthDate) {
        const today = new Date();
        const diff = today - birthDate;
        const ageDate = new Date(diff); // Convertir la diferencia en una fecha
        return Math.abs(ageDate.getUTCFullYear() - 1970); // Calcular la edad en años
      }

      // Evento cuando se cambia la fecha de nacimiento para calcular la edad
      document.getElementById('fecha_nacimiento_fam').addEventListener('change', function() {
        const birthDate = new Date(this.value);
        const age = calculateAge(birthDate);
        document.getElementById('Edad_fam').value = age;
      });

      // Manejar el envío del formulario
      document.getElementById('alta_bene_fam').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => { data[key] = value });

        fetch('/AltaBeneFamiliar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            mostrarMensaje('error', data.error);
          } else {
            mostrarMensaje('exito', data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          mostrarMensaje('error', 'Error interno del servidor');
        });
      });
    });
  </script>
  <script>
    document.getElementById('alta_bene_fam').addEventListener('submit', async function(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch('/AltaBeneFamiliar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log('Resultado de la respuesta:', result);

        if (response.ok) {
          alert(result.message);
          window.location.href = '/entrada_inicio';
        } else {
          alert(result.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al enviar el formulario');
      }
    });
  </script>
</body>
</html>
